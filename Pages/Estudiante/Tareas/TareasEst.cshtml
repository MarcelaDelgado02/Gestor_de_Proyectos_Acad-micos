@page
@model Gestor_de_Proyectos_Académicos.Pages.Estudiante.Tareas.TareasEstModel
@{
    ViewData["Title"] = "Mis tareas del proyecto";
}

<h2 class="text-center mt-4">Mis tareas del proyecto</h2>

<div class="text-center mt-3">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalCrear">
        Crear Tarea
    </button>

    <a class="btn btn-secondary" asp-page="/Estudiante/inicio/inicioEst">
        Volver
    </a>
</div>
@if (Model.Avisos == null || !Model.Avisos.Any())
{
    <div class="alert alert-info">
         No tienes avisos por el momento. ¡Todo está al día!
    </div>
}
else
{
    @foreach (var tarea in Model.Avisos)
    {
        <div class="alert alert-@tarea.ColorAviso shadow-sm p-3 mb-3 rounded">
            <h5 class="fw-bold mb-1">@tarea.TituloTarea</h5>
            <small class="d-block text-muted">
                Fecha límite: @tarea.FechaLimiteTarea.ToString("dd/MM/yyyy")
            </small>

            @if (tarea.EstaPorVencer)
            {
                <span class="badge bg-warning text-dark mt-2">⚠️ ¡Esta tarea está por vencer!</span>
            }
            else if (tarea.EstaVencida)
            {
                <span class="badge bg-danger mt-2">⛔ Tarea vencida</span>
            }
        </div>
    }
}

<!-- Mostrar mensajes -->
@if (!string.IsNullOrEmpty(Model.Mensaje))
{
    <div class="alert alert-success mt-3">@Model.Mensaje</div>
}
@if (!string.IsNullOrEmpty(Model.MensajeError))
{
    <div class="alert alert-danger mt-3">@Model.MensajeError</div>
}

@if (Model.Tareas != null && Model.Tareas.Count > 0)
{
    <table class="table table-bordered table-striped mt-4">
        <thead>
            <tr>
                <th>Título</th>
                <th>Descripción</th>
                <th>Fecha Límite</th>
                <th>Estado Actual</th>
                <th>Actualizar Estado</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var t in Model.Tareas)
            {
                bool estaVencida = Model.TareaEstaVencida(t);
                string filaColor = estaVencida ? "table-danger" : "";

                <tr class="@filaColor">
                    <td>
                        @t.TituloTarea
                        @if (estaVencida)
                        {
                            <span class="badge bg-danger ms-2">VENCIDA</span>
                        }
                    </td>
                    <td>@t.DescripcionTarea</td>
                    <td>@t.FechaLimiteTarea.ToShortDateString()</td>
                    <td>
                        <span class="badge bg-@(t.EstadoTarea == "Completada" ? "success" : t.EstadoTarea == "En Progreso" ? "warning" : "secondary")">
                            @t.EstadoTarea
                        </span>
                    </td>

                    <td>
                        <form method="post" asp-page-handler="ActualizarEstado">
                            <input type="hidden" name="idTarea" value="@t.IdTarea" />
                            <input type="hidden" name="IdProyecto" value="@Model.IdProyecto" />

                            <select name="nuevoEstado" class="form-select form-select-sm"
                            @(estaVencida ? "disabled" : "")>
                                <option value="Pendiente" selected="@(t.EstadoTarea == "Pendiente")">Pendiente</option>
                                <option value="En Progreso" selected="@(t.EstadoTarea == "En Progreso")">En Progreso</option>
                                <option value="Completada" selected="@(t.EstadoTarea == "Completada")">Completada</option>
                            </select>

                            @if (estaVencida)
                            {
                                <button type="button" class="btn btn-secondary btn-sm mt-1" disabled>
                                    <i class="fas fa-lock"></i> Bloqueada
                                </button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-success btn-sm mt-1">
                                    <i class="fas fa-save"></i> Actualizar
                                </button>
                            }
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-center mt-3">Aún no hay tareas para este proyecto.</p>
}

<!-- Modal Crear Tarea -->
<div class="modal fade" id="modalCrear" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="Crear">
                <div class="modal-header">
                    <h5 class="modal-title">Crear Tarea</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="IdProyecto" value="@Model.IdProyecto" />

                    <div class="mb-3">
                        <label class="form-label">Título</label>
                        <input class="form-control" asp-for="Titulo" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" asp-for="Descripcion" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fecha Límite</label>
                        <input type="date" class="form-control" asp-for="FechaLimite"
                               min="@DateTime.Now.ToString("yyyy-MM-dd")"
                               value="@DateTime.Now.AddDays(7).ToString("yyyy-MM-dd")" required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear</button>
                </div>
            </form>
        </div>
    </div>
</div>